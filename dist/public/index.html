!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tips</title>
</head>

<body>
  <div class="grid">
      <!-- Form to submit tips -->
      <form id="tipForm" action="/tip" method="POST">

        <!-- Tip Input required -->
        <label for="tip">Tip</label>
        <div class="inputCon">
        <input id="tip" class="linput" type="text" name="tip" required />

        <!-- Signing Input -->
        <canvas class="signingInput"></canvas>
        <button type="button" class="resetbtn">Reset</button>
        </div>

        <div class="buttonGroup">
          <button id="githubbtn" type="button">Login to Github</button>
          <button type="button">Post without Github</button>
        </div>
      </form></br></br>

    <div class="postGrid">
      <!-- Tips will be shown here -->
    </div>
  </div>

  <!-- Top (fix position not in grid) -->
<div class="top">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="75.236 34.552 49.528 130.896" width="20px" height="40px">
    <defs>
      <linearGradient gradientUnits="userSpaceOnUse" x1="100" y1="34.552" x2="100" y2="165.448" id="gradient-0">
        <stop offset="0" style="stop-color: rgb(90% 90% 90%)" />
        <stop offset="1" style="stop-color: rgb(119,119,119)" />
      </linearGradient>
    </defs>
    <rect style="stroke: url(&quot;#gradient-0&quot;); stroke-miterlimit: 1; stroke-width: 0px; fill: rgb(119,119,119);" x="75.236" y="34.552" width="49.528" height="130.896" rx="24.8" ry="24.8" />
  </svg>
  
  <ul>
    <li>l@icloud.com</li>
    <a href="#skills">
      <li>Skills</li>
    </a>
    <li>Tips</li>
  </ul>
  </div>

  <!-- Bottom (fix position not in grid) -->
<div class="bottom">
  <ul>
    <li>git</li>
    <li>lin</li>
  </ul>
</div>

  <style>

    /*
    **
    ** Top
    **
    ** Bottom
    **
    ** Grid
    **
    ** Form
    **
    ** Tip
    **
    ** Cursor
    **
    ** Helpers
    **
    */

* {
  margin: 0;
  padding: 0;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: system-ui;
  font-size: 2.9vh;
  color: #777777;
  height: 100vh;
}

/* ---------- #TOP ---------- */
  
.top {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 10vh;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 20px 20px 40px;
    z-index: 100;
  }
  
  .top li {
    float: left;
    margin: 0 20px 0 0;
  }
  
  /* ---------- #BOTTOM ---------- */
  
  .bottom {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 20px;
  }
  
  .bottom li {
    float: right;
    font-family: monospace;
    margin: 0 20px 24px 0;
  }

/* ---------- #GRID ---------- */

.grid {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: start;
  justify-content: center;
  width: 70vw;
  height: 70vh;
  border: 1px solid #777777;
  overflow: scroll;
}

.topRow {
  border: 1px solid transparent;
  border-radius: 20px;
  color: #ffffff;
  padding: 20px;
}

.postGrid {
  display: flex;
  flex-direction: column;
  width: 100%;
  color: #bdbdbd;
}

/* ---------- #FORM ---------- */

form {
  display: flex;
  flex-direction: column;
}

label {
  color: #bdbdbd;
  margin: 0 10px;
}

input {
  height: 22px;
  border: 1px solid #cccccc;
  border-radius: 10px;
  color: #bdbdbd;
  margin: 4px 0 10px 0;
  padding: 0 10px;
}

input:focus{
    outline: none;
}

.linput {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60%;
  border: 1px solid #cccccc;
  border-bottom: none;
  border-radius: 10px 10px 0 0;
  overflow: scroll;
}

.inputCon {
  position: relative;
  width: 70vw;
  height: 20vh;
}

.signingInput {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  width: calc(100% - 1.9px);
  height: 40%;
  border: 1px solid #cccccc;
  border-top: none;
  border-radius: 0 0 10px 10px;
  background-color: #ffffff;
  cursor: url(pen.png) 1 26, pointer;
}

.resetbtn {
  position: absolute;
  right: 10px;
  bottom: 10px;
  font-size: 12px;
  background: none;
  color: #bdbdbd;
  padding: 4px 10px;
  cursor: pointer;
}

.resetbtn:hover {
  background: none;
  color: rgb(219,219,219,0.7);
}

.buttonGroup {
  display: flex;
  justify-content: space-between;
  width: 240px;
  margin: 10px 7px;
}

button {
  height: 27px;
  border: 1px solid transparent;
  border-radius: 20px;
  background-color: #dbdbdb;
  color: #ffffff;
  padding: 0 10px;
  cursor: pointer;
}

button:hover {
  background-color: rgb(219,219,219,0.7);
}

/* ---------- #TIP ---------- */

.tipCon {
  position: relative;
  display: flex;
  flex-direction: column;
  height: 100px;
  border: 1px solid #bdbdbd;
  border-radius: 10px;
  margin-bottom: 10px;
  margin: 0 0 20px 0;
  padding: 20px;
}

.tip {
  margin: 0 0 20px 0;
}

.github  {
  position: absolute;
  left: 20px;
  bottom: 20px;
  cursor: pointer;
}

.github a {
  color: #bdbdbd;
  text-decoration: none;
}

 /* ---------- #CURSOR ---------- */
  
 .cursor {
    position: absolute;
    height: 7vh;
    aspect-ratio: 4/10;
    border-radius: 20px;
    background-color: rgba(119, 119, 119, 0.29);
    pointer-events: none;
    transform: translate(-50%, -50%);
    transition: transform 0.08s linear;
  }

/* ---------- #HELPERS ---------- */

h1 {
    font-size: 4.9vh;
  }
  
  a {
    text-decoration: none;
    color: #777777;
    cursor: none;
  }
  
  p {
    margin: 4.9px 0;
  }
  
  ul {
    list-style-type: none;
  }

</style>

<script>

  // Custom Cursor
  document.addEventListener("DOMContentLoaded", () => {
    // Create the cursor element
    const cursor = document.createElement("div");
    cursor.classList.add("cursor");
    document.body.appendChild(cursor);

    // Ensure the cursor is displayed
    cursor.style.display = "block";

    // Update cursor position
    document.addEventListener("mousemove", (e) => {
        const offsetX = 10; // Adjust for positioning
        const offsetY = 10;
        
        cursor.style.left = `${e.pageX + offsetX}px`;
        cursor.style.top = `${e.pageY + offsetY}px`;
    });

    // Hide the default cursor
    document.body.style.cursor = "none";
});

// Log in to Github
document.getElementById('githubbtn').addEventListener('click', function () {
    const clientId = 'YOUR_GITHUB_CLIENT_ID'; // Replace with your GitHub OAuth App Client ID
    const redirectUri = 'YOUR_REDIRECT_URI'; // Replace with your redirect URI
    const scope = 'read:user user:email'; // Adjust scopes as needed

    const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;

    window.location.href = githubAuthUrl; // Redirect to GitHub OAuth
});

// Form submission

const form = document.getElementById('tipForm');
const tipInput = document.getElementById('tip');
const githubInput = document.getElementById('github');
const githubURLInput = document.getElementById('githubURL');
const signingInput = document.querySelector('.signingInput');
const ctx = signingInput.getContext('2d');
const postGrid = document.querySelector('.postGrid');

let drawing = false;

// Mousedown event for desktop
signingInput.addEventListener('mousedown', (e) => {
    drawing = true;
    const rect = signingInput.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.beginPath();
    ctx.moveTo(x, y);
});

signingInput.addEventListener('mouseup', () => (drawing = false));
signingInput.addEventListener('mouseleave', () => (drawing = false));

// Touch events for mobile
signingInput.addEventListener('touchstart', (e) => {
    e.preventDefault();
    drawing = true;
    const rect = signingInput.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    ctx.beginPath();
    ctx.moveTo(x, y);
});

signingInput.addEventListener('touchend', () => (drawing = false));
signingInput.addEventListener('touchcancel', () => (drawing = false));

signingInput.addEventListener('mousemove', draw);
signingInput.addEventListener('touchmove', (e) => {
    e.preventDefault();
    draw(e);
});

function draw(e) {
    if (!drawing) return;

    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#dbdbdb';

    const rect = signingInput.getBoundingClientRect();
    let x, y;

    // Get current mouse/touch position
    if (e.type === 'mousemove') {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    } else if (e.type === 'touchmove') {
        const touch = e.touches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
    }

    if (drawing) {
        ctx.lineTo(x, y);
        ctx.stroke(); // Render the stroke
    }
}

const resetBtn = document.querySelector('.resetbtn');

resetBtn.addEventListener('click', () => {
  ctx.clearRect(0, 0, signingInput.width, signingInput.height); // Reset .signingInput
});

// Form submission
form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const tip = tipInput.value.trim();
    const github = githubInput.value.trim();
    const githubURL = githubURLInput.value.trim();
    const signing = signingInput.toDataURL(); // Capture signature as Base64 image

    if (!tip) {
        alert('Tip is required.');
        return;
    }

    try {
        const response = await fetch('/tip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tip, github, githubURL, signing }),
        });

        const result = await response.json();
        console.log('Server response:', result); // Debugging

        if (response.ok) {
            const newTipElement = createTipElement(result.tip, result.github, result.githubURL, result.signing);

            // Prepend the new tip to the top of the list
            postGrid.insertBefore(newTipElement, postGrid.firstChild);

            // Reset form inputs
            form.reset();
            ctx.clearRect(0, 0, signingInput.width, signingInput.height); // Clear signature canvas
        } else {
            alert(result.error || 'Unknown error');
        }
    } catch (error) {
        console.error('Error submitting tip:', error);
        alert('Error occurred while submitting your tip.');
    }
});

// Function to create a new tip element
function createTipElement(tip, github, githubURL, signing) {
    const tipCon = document.createElement('div');
    tipCon.className = 'tipCon';

    const tipElement = document.createElement('div');
    tipElement.className = 'tip';
    tipElement.textContent = tip;

    const githubElement = document.createElement('div');
    githubElement.className = 'github';

    if (github && githubURL) {
        const link = document.createElement('a');
        link.href = githubURL;
        link.textContent = github;
        link.target = '_blank';
        githubElement.appendChild(link);
    } else {
        githubElement.textContent = github;
    }

    tipCon.appendChild(tipElement);
    tipCon.appendChild(githubElement);

    if (signing) {
        console.log("Rendering Image:", signing); // Debugging
        const img = document.createElement('img');
        img.src = signing;
        img.style.width = '100%';

        tipCon.appendChild(img);
    }

    return tipCon;
}

document.addEventListener('DOMContentLoaded', fetchTips);

async function fetchTips() {
    try {
        const response = await fetch('/tip');
        const tips = await response.json();

        postGrid.innerHTML = ''; // Reset previous content

        tips.forEach((tipData) => {
            const newTipElement = createTipElement(
                tipData.tip, 
                tipData.github, 
                tipData.githubURL, 
                tipData.signing
            );
            postGrid.appendChild(newTipElement);
        });
    } catch (error) {
        console.error('Error fetching tips:', error);
    }
}

</script>
</body>

</html>